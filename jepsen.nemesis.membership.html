<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>jepsen.nemesis.membership documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Jepsen</span> <span class="project-version">0.3.8</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jepsen</span></div></div></li><li class="depth-2 branch"><a href="jepsen.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-2"><a href="jepsen.checker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>checker</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.clock.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clock</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.perf.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>perf</span></div></a></li><li class="depth-3"><a href="jepsen.checker.timeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>timeline</span></div></a></li><li class="depth-2 branch"><a href="jepsen.cli.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>cli</span></div></a></li><li class="depth-2 branch"><a href="jepsen.client.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>client</span></div></a></li><li class="depth-2 branch"><a href="jepsen.codec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>codec</span></div></a></li><li class="depth-2"><a href="jepsen.control.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>control</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.clj-ssh.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clj-ssh</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.docker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>docker</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.k8s.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>k8s</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.net.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.retry.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>retry</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.scp.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>scp</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.sshj.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sshj</span></div></a></li><li class="depth-3"><a href="jepsen.control.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2 branch"><a href="jepsen.core.html"><div class="inner"><span class="tree" style="top: -300px;"><span class="top" style="height: 309px;"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch"><a href="jepsen.db.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>db</span></div></a></li><li class="depth-2 branch"><a href="jepsen.faketime.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>faketime</span></div></a></li><li class="depth-2 branch"><a href="jepsen.fs-cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fs-cache</span></div></a></li><li class="depth-2"><a href="jepsen.generator.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>generator</span></div></a></li><li class="depth-3 branch"><a href="jepsen.generator.context.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>context</span></div></a></li><li class="depth-3 branch"><a href="jepsen.generator.interpreter.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interpreter</span></div></a></li><li class="depth-3 branch"><a href="jepsen.generator.test.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>test</span></div></a></li><li class="depth-3"><a href="jepsen.generator.translation-table.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>translation-table</span></div></a></li><li class="depth-2 branch"><a href="jepsen.independent.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>independent</span></div></a></li><li class="depth-2 branch"><a href="jepsen.lazyfs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>lazyfs</span></div></a></li><li class="depth-2"><a href="jepsen.nemesis.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>nemesis</span></div></a></li><li class="depth-3 branch"><a href="jepsen.nemesis.combined.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>combined</span></div></a></li><li class="depth-3 branch"><a href="jepsen.nemesis.file.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>file</span></div></a></li><li class="depth-3 current"><a href="jepsen.nemesis.membership.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>membership</span></div></a></li><li class="depth-4"><a href="jepsen.nemesis.membership.state.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>state</span></div></a></li><li class="depth-3"><a href="jepsen.nemesis.time.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>time</span></div></a></li><li class="depth-2"><a href="jepsen.net.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3"><a href="jepsen.net.proto.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>proto</span></div></a></li><li class="depth-2"><a href="jepsen.os.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>os</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.centos.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>centos</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.debian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>debian</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.smartos.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>smartos</span></div></a></li><li class="depth-3"><a href="jepsen.os.ubuntu.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ubuntu</span></div></a></li><li class="depth-2 branch"><a href="jepsen.reconnect.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>reconnect</span></div></a></li><li class="depth-2 branch"><a href="jepsen.repl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>repl</span></div></a></li><li class="depth-2 branch"><a href="jepsen.report.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>report</span></div></a></li><li class="depth-2 branch"><a href="jepsen.role.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>role</span></div></a></li><li class="depth-2"><a href="jepsen.store.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>store</span></div></a></li><li class="depth-3 branch"><a href="jepsen.store.format.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>format</span></div></a></li><li class="depth-3"><a href="jepsen.store.fressian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fressian</span></div></a></li><li class="depth-2"><a href="jepsen.tests.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>tests</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.bank.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bank</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.causal.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>causal</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.causal-reverse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>causal-reverse</span></div></a></li><li class="depth-3"><a href="jepsen.tests.cycle.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cycle</span></div></a></li><li class="depth-4 branch"><a href="jepsen.tests.cycle.append.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>append</span></div></a></li><li class="depth-4"><a href="jepsen.tests.cycle.wr.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>wr</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.kafka.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>kafka</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.linearizable-register.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>linearizable-register</span></div></a></li><li class="depth-3"><a href="jepsen.tests.long-fork.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>long-fork</span></div></a></li><li class="depth-2 branch"><a href="jepsen.util.html"><div class="inner"><span class="tree" style="top: -331px;"><span class="top" style="height: 340px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="jepsen.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="jepsen.nemesis.membership.html#var-initial-state"><div class="inner"><span>initial-state</span></div></a></li><li class="depth-1"><a href="jepsen.nemesis.membership.html#var-node-view-future"><div class="inner"><span>node-view-future</span></div></a></li><li class="depth-1"><a href="jepsen.nemesis.membership.html#var-node-view-interval"><div class="inner"><span>node-view-interval</span></div></a></li><li class="depth-1"><a href="jepsen.nemesis.membership.html#var-package"><div class="inner"><span>package</span></div></a></li><li class="depth-1"><a href="jepsen.nemesis.membership.html#var-resolve"><div class="inner"><span>resolve</span></div></a></li><li class="depth-1"><a href="jepsen.nemesis.membership.html#var-resolve-ops"><div class="inner"><span>resolve-ops</span></div></a></li><li class="depth-1"><a href="jepsen.nemesis.membership.html#var-State"><div class="inner"><span>State</span></div></a></li><li class="depth-1"><a href="jepsen.nemesis.membership.html#var-update-node-view.21"><div class="inner"><span>update-node-view!</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">jepsen.nemesis.membership</h1><div class="doc"><div class="markdown"><p>EXPERIMENTAL: provides standardized support for nemeses which add and remove nodes from a cluster.</p>
<p>This is a tricky problem. Even the concept of cluster state is complicated: there is Jepsen’s knowledge of the state, and each individual node’s understanding of the current state. Depending on which node you ask, you may get more or less recent (or, frequently, divergent) views of cluster state. Cluster state representation is highly variable across databases, which means our standardized state machine must allow for that variability.</p>
<p>We are guided by some principles that crop up repeatedly in writing these sorts of nemeses:</p>
<ol>
<li>
<p>We should avoid creating useless cluster states–e.g. those that can’t fulfill any requests–for very long.</p>
</li>
<li>
<p>There are both safe and unsafe transitions. In general, commands like join/remove should always be safe. Removing data, however, is <em>unsafe</em> unless we can prove the node has been properly removed.</p>
</li>
<li>
<p>We <em>want</em> to leave nodes running, with data files intact, after removing them. This is when interesting things happen.</p>
</li>
<li>
<p>We must be safe in the presence of concurrent node kill/restart operations.</p>
</li>
<li>
<p>Nodes tend to go down or fail to reach the rest of the cluster, but we want to continue making decisions during this time.</p>
</li>
<li>
<p>Requested changes to the cluster may time out, or simply take a while to perform. We need to <em>remember</em> these ongoing operations, use them to constrain our choices of further changes (e.g. if four node removals are underway, don’t initiate a fifth), and find ways to resolve those ongoing changes, e.g. by confirming they took place.</p>
</li>
</ol>
<p>Our general approach is to define a sort of state machine where the state is our representation of the cluster state, how all nodes view the cluster, and the set of ongoing operations, plus any auxiliary material (e.g. after completing a node removal, we can delete its data files). This state is periodically <em>updated</em> by querying individual nodes, and <em>also</em> by performing operations–e.g. initiating a node removal.</p>
<p>The generator constructs those operations by asking the nemesis what sorts of operations would be legal to perform at this time, and picking one of those. It then passes that operation back to the nemesis (via nemesis/invoke!), and the nemesis updates its local state and performs the operation.</p>
</div></div><div class="public anchor" id="var-initial-state"><h3>initial-state</h3><div class="usage"><code>(initial-state test)</code></div><div class="doc"><div class="markdown"><p>Constructs an initial cluster state map for the given test.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/nemesis/membership.clj#L68">view source</a></div></div><div class="public anchor" id="var-node-view-future"><h3>node-view-future</h3><div class="usage"><code>(node-view-future test state running? opts node)</code></div><div class="doc"><div class="markdown"><p>Spawns a future which keeps the given state atom updated with our view of this node.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/nemesis/membership.clj#L143">view source</a></div></div><div class="public anchor" id="var-node-view-interval"><h3>node-view-interval</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How many seconds between updating node views.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/nemesis/membership.clj#L59">view source</a></div></div><div class="public anchor" id="var-package"><h3>package</h3><div class="usage"><code>(package opts)</code></div><div class="doc"><div class="markdown"><p>Constructs a nemesis and generator for membership operations. Options are a map like</p>
<p>{:faults #{:membership …} :membership membership-opts}.</p>
<p>Membership opts are:</p>
<p>{:state           A record satisfying the State protocol :log-resolve-op? Whether to log the resolution of operations :log-resolve?    Whether to log each resolve step :log-node-views? Whether to log changing node views :log-view?       Whether to log the entire cluster view.</p>
<p>The package includes a :state field, which is an atom of the current cluster state. You can use this (for example) to have generators which inspect the current cluster state and use it to target faults.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/nemesis/membership.clj#L239">view source</a></div></div><div class="public anchor" id="var-resolve"><h3>resolve</h3><div class="usage"><code>(resolve state test opts)</code></div><div class="doc"><div class="markdown"><p>Resolves a state towards its final form by calling resolve and resolve-ops until converged.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/nemesis/membership.clj#L95">view source</a></div></div><div class="public anchor" id="var-resolve-ops"><h3>resolve-ops</h3><div class="usage"><code>(resolve-ops state test opts)</code></div><div class="doc"><div class="markdown"><p>Try to resolve any pending ops we can. Returns state with those ops resolved.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/nemesis/membership.clj#L79">view source</a></div></div><div class="public anchor" id="var-State"><h3>State</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"><p>For convenience, a copy of the membership State protocol. This lets users implement the protocol without requiring the state namespace themselves.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/nemesis/membership.clj#L63">view source</a></div></div><div class="public anchor" id="var-update-node-view.21"><h3>update-node-view!</h3><div class="usage"><code>(update-node-view! state test node opts)</code></div><div class="doc"><div class="markdown"><p>Takes an atom wrapping a State, a test, and a node. Gets the current view from that node’s perspective, and updates the state atom to reflect it.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/nemesis/membership.clj#L109">view source</a></div></div></div></body></html>