<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>jepsen.store.format documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Jepsen</span> <span class="project-version">0.3.8</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jepsen</span></div></div></li><li class="depth-2 branch"><a href="jepsen.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-2"><a href="jepsen.checker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>checker</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.clock.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clock</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.perf.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>perf</span></div></a></li><li class="depth-3"><a href="jepsen.checker.timeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>timeline</span></div></a></li><li class="depth-2 branch"><a href="jepsen.cli.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>cli</span></div></a></li><li class="depth-2 branch"><a href="jepsen.client.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>client</span></div></a></li><li class="depth-2 branch"><a href="jepsen.codec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>codec</span></div></a></li><li class="depth-2"><a href="jepsen.control.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>control</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.clj-ssh.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clj-ssh</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.docker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>docker</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.k8s.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>k8s</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.net.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.retry.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>retry</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.scp.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>scp</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.sshj.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sshj</span></div></a></li><li class="depth-3"><a href="jepsen.control.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2 branch"><a href="jepsen.core.html"><div class="inner"><span class="tree" style="top: -300px;"><span class="top" style="height: 309px;"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch"><a href="jepsen.db.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>db</span></div></a></li><li class="depth-2 branch"><a href="jepsen.faketime.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>faketime</span></div></a></li><li class="depth-2 branch"><a href="jepsen.fs-cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fs-cache</span></div></a></li><li class="depth-2"><a href="jepsen.generator.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>generator</span></div></a></li><li class="depth-3 branch"><a href="jepsen.generator.context.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>context</span></div></a></li><li class="depth-3 branch"><a href="jepsen.generator.interpreter.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interpreter</span></div></a></li><li class="depth-3 branch"><a href="jepsen.generator.test.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>test</span></div></a></li><li class="depth-3"><a href="jepsen.generator.translation-table.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>translation-table</span></div></a></li><li class="depth-2 branch"><a href="jepsen.independent.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>independent</span></div></a></li><li class="depth-2 branch"><a href="jepsen.lazyfs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>lazyfs</span></div></a></li><li class="depth-2"><a href="jepsen.nemesis.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>nemesis</span></div></a></li><li class="depth-3 branch"><a href="jepsen.nemesis.combined.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>combined</span></div></a></li><li class="depth-3 branch"><a href="jepsen.nemesis.file.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>file</span></div></a></li><li class="depth-3"><a href="jepsen.nemesis.membership.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>membership</span></div></a></li><li class="depth-4"><a href="jepsen.nemesis.membership.state.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>state</span></div></a></li><li class="depth-3"><a href="jepsen.nemesis.time.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>time</span></div></a></li><li class="depth-2"><a href="jepsen.net.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3"><a href="jepsen.net.proto.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>proto</span></div></a></li><li class="depth-2"><a href="jepsen.os.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>os</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.centos.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>centos</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.debian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>debian</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.smartos.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>smartos</span></div></a></li><li class="depth-3"><a href="jepsen.os.ubuntu.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ubuntu</span></div></a></li><li class="depth-2 branch"><a href="jepsen.reconnect.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>reconnect</span></div></a></li><li class="depth-2 branch"><a href="jepsen.repl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>repl</span></div></a></li><li class="depth-2 branch"><a href="jepsen.report.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>report</span></div></a></li><li class="depth-2 branch"><a href="jepsen.role.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>role</span></div></a></li><li class="depth-2"><a href="jepsen.store.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>store</span></div></a></li><li class="depth-3 branch current"><a href="jepsen.store.format.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>format</span></div></a></li><li class="depth-3"><a href="jepsen.store.fressian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fressian</span></div></a></li><li class="depth-2"><a href="jepsen.tests.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>tests</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.bank.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bank</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.causal.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>causal</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.causal-reverse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>causal-reverse</span></div></a></li><li class="depth-3"><a href="jepsen.tests.cycle.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cycle</span></div></a></li><li class="depth-4 branch"><a href="jepsen.tests.cycle.append.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>append</span></div></a></li><li class="depth-4"><a href="jepsen.tests.cycle.wr.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>wr</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.kafka.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>kafka</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.linearizable-register.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>linearizable-register</span></div></a></li><li class="depth-3"><a href="jepsen.tests.long-fork.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>long-fork</span></div></a></li><li class="depth-2 branch"><a href="jepsen.util.html"><div class="inner"><span class="tree" style="top: -331px;"><span class="top" style="height: 340px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="jepsen.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="jepsen.store.format.html#var-append-to-big-vector-block.21"><div class="inner"><span>append-to-big-vector-block!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-append-to-fressian-stream-block.21"><div class="inner"><span>append-to-fressian-stream-block!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-assoc-block.21"><div class="inner"><span>assoc-block!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-big-vector-block-writer.21"><div class="inner"><span>big-vector-block-writer!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-big-vector-block-writer-worker.21"><div class="inner"><span>big-vector-block-writer-worker!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-big-vector-chunk-size"><div class="inner"><span>big-vector-chunk-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-big-vector-count-size"><div class="inner"><span>big-vector-count-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-big-vector-index-size"><div class="inner"><span>big-vector-index-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-checksum"><div class="inner"><span>block-checksum</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-checksum-given-data-checksum"><div class="inner"><span>block-checksum-given-data-checksum</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-checksum-offset"><div class="inner"><span>block-checksum-offset</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-checksum-size"><div class="inner"><span>block-checksum-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-header"><div class="inner"><span>block-header</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-header-checksum"><div class="inner"><span>block-header-checksum</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-header-for-data"><div class="inner"><span>block-header-for-data</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-header-for-length-and-checksum.21"><div class="inner"><span>block-header-for-length-and-checksum!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-header-length"><div class="inner"><span>block-header-length</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-header-size"><div class="inner"><span>block-header-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-header-type"><div class="inner"><span>block-header-type</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-id-size"><div class="inner"><span>block-id-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-index-data-size"><div class="inner"><span>block-index-data-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-index-offset-offset"><div class="inner"><span>block-index-offset-offset</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-len-offset"><div class="inner"><span>block-len-offset</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-len-size"><div class="inner"><span>block-len-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-offset-size"><div class="inner"><span>block-offset-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-ref"><div class="inner"><span>block-ref</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-references"><div class="inner"><span>block-references</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-type-.3Eshort"><div class="inner"><span>block-type-&gt;short</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-type-offset"><div class="inner"><span>block-type-offset</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-block-type-size"><div class="inner"><span>block-type-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-check-block-checksum"><div class="inner"><span>check-block-checksum</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-check-magic"><div class="inner"><span>check-magic</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-check-version.21"><div class="inner"><span>check-version!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-close.21"><div class="inner"><span>close!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-copy.21"><div class="inner"><span>copy!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-current-version"><div class="inner"><span>current-version</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-find-references"><div class="inner"><span>find-references</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-first-block-offset"><div class="inner"><span>first-block-offset</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-flush.21"><div class="inner"><span>flush!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-fressian-buffer-size"><div class="inner"><span>fressian-buffer-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-fressian-read-handlers"><div class="inner"><span>fressian-read-handlers</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-fressian-stream-block-writer.21"><div class="inner"><span>fressian-stream-block-writer!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-fressian-write-handlers"><div class="inner"><span>fressian-write-handlers</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-gc.21"><div class="inner"><span>gc!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-IPartialMap"><div class="inner"><span>IPartialMap</span></div></a></li><li class="depth-2"><a href="jepsen.store.format.html#var-partial-map-rest-id"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>partial-map-rest-id</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-large-region-size"><div class="inner"><span>large-region-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-load-block-index.21"><div class="inner"><span>load-block-index!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-magic"><div class="inner"><span>magic</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-magic-offset"><div class="inner"><span>magic-offset</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-magic-size"><div class="inner"><span>magic-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-new-block-id.21"><div class="inner"><span>new-block-id!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-next-block-offset"><div class="inner"><span>next-block-offset</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-open"><div class="inner"><span>open</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-prep-read.21"><div class="inner"><span>prep-read!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-prep-write.21"><div class="inner"><span>prep-write!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-big-vector-block"><div class="inner"><span>read-big-vector-block</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-block-by-id"><div class="inner"><span>read-block-by-id</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-block-by-offset"><div class="inner"><span>read-block-by-offset</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-block-by-offset*"><div class="inner"><span>read-block-by-offset*</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-block-data"><div class="inner"><span>read-block-data</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-block-header"><div class="inner"><span>read-block-header</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-block-index-block"><div class="inner"><span>read-block-index-block</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-block-index-offset"><div class="inner"><span>read-block-index-offset</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-file"><div class="inner"><span>read-file</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-fressian-block"><div class="inner"><span>read-fressian-block</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-fressian-stream-block"><div class="inner"><span>read-fressian-stream-block</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-partial-map-block"><div class="inner"><span>read-partial-map-block</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-root"><div class="inner"><span>read-root</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-read-test"><div class="inner"><span>read-test</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-set-block-header-checksum.21"><div class="inner"><span>set-block-header-checksum!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-set-block-header-length.21"><div class="inner"><span>set-block-header-length!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-set-block-header-type.21"><div class="inner"><span>set-block-header-type!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-set-root.21"><div class="inner"><span>set-root!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-short-.3Eblock-type"><div class="inner"><span>short-&gt;block-type</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-test-history-writer.21"><div class="inner"><span>test-history-writer!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-version"><div class="inner"><span>version</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-version-offset"><div class="inner"><span>version-offset</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-version-size"><div class="inner"><span>version-size</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-big-vector-block.21"><div class="inner"><span>write-big-vector-block!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-block.21"><div class="inner"><span>write-block!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-block-data.21"><div class="inner"><span>write-block-data!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-block-header.21"><div class="inner"><span>write-block-header!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-block-index.21"><div class="inner"><span>write-block-index!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-block-index-offset.21"><div class="inner"><span>write-block-index-offset!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-file.21"><div class="inner"><span>write-file!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-fressian-block.21"><div class="inner"><span>write-fressian-block!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-fressian-block.21*"><div class="inner"><span>write-fressian-block!*</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-fressian-to-file.21"><div class="inner"><span>write-fressian-to-file!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-header.21"><div class="inner"><span>write-header!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-initial-test.21"><div class="inner"><span>write-initial-test!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-partial-map-block.21"><div class="inner"><span>write-partial-map-block!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-partial-map-block.21*"><div class="inner"><span>write-partial-map-block!*</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-test.21"><div class="inner"><span>write-test!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-test-with-history.21"><div class="inner"><span>write-test-with-history!</span></div></a></li><li class="depth-1"><a href="jepsen.store.format.html#var-write-test-with-results.21"><div class="inner"><span>write-test-with-results!</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">jepsen.store.format</h1><div class="doc"><div class="markdown"><p>Jepsen tests are logically a map. To save this map to disk, we originally wrote it as a single Fressian file. This approach works reasonably well, but has a few problems:</p>
<ul>
<li>
<p>We write test files multiple times: once at the end of a test, and once once the analysis is complete–in case the analysis fails. Rewriting the entire file is inefficient. It would be nice to incrementally append new state.</p>
</li>
<li>
<p>Histories are <em>enormous</em> relative to tests, but we force readers to deserialize them before being able to get to any other high-level keys in the test–for instance, the result map.</p>
</li>
<li>
<p>It might be nice, someday, to have histories bigger than fit into memory.</p>
</li>
<li>
<p>We have no way to incrementally write the history, which means if a test crashes during the run we lose everything.</p>
</li>
<li>
<p>Deserializing histories is a linear process, but it would be nice for analyses to be able to parallelize.</p>
</li>
<li>
<p>The web view needs a <em>little</em> metadata quickly: the name, the date, the valid field of the result map. Forcing it to deserialize the entire world to get this information is bad.</p>
</li>
<li>
<p>Likewise, loading tests at the REPL is cumbersome–if all one wants is the results, you should be able to skip the history. Working with the history should ideally be lazy.</p>
</li>
</ul>
<p>I held off on designing a custom serialization format for Jepsen for many years, but at this point the design constraints feel pretty well set, and I think the time is right to design a custom format.</p>
<h2><a href="#file-format-structure" id="file-format-structure"></a>File Format Structure</h2>
<p>Jepsen files begin with the magic UTF8 string JEPSEN, followed by a 32-byte big-endian unsigned integer version field, which we use to read old formats when necessary. Then there is a 64-bit offset into the file where the <em>block index</em>–the metadata structure–lives. There follows a series of <em>blocks</em>:</p>
<pre><code>   6            32             64
</code></pre>
<p>| “JEPSEN” | version | block-index-offset | block 1 | block 2 | …</p>
<p>In general, files are written by appending blocks sequentially to the end of the file—this allows Jepsen to write files in (mostly) a single pass, without moving large chunks of bytes around. When one is ready to save the file, one writes a new index block to the end of the file which provides the offsets of all the (active) blocks in the file, and finally updates the block-index-offset at the start of the file to point to that most-recent index block.</p>
<p>All integers are signed and big-endian, unless otherwise noted. This is the JVM, after all.</p>
<p>Blocks may be sparse–their lengths may be shorter than the distance to the start of the next block. This is helpful if one needs to rewrite blocks later: you can leave padding for their sizes to change.</p>
<p>The top-level value of the file (e.g. the test map) is given in the block index.</p>
<h2><a href="#block-structure" id="block-structure"></a>Block Structure</h2>
<p>All blocks begin with an 8-byte length prefix which indicates the length of the block in bytes, including the length prefix itself. Then follows a CRC32 checksum. Third, we have a 16-bit block type field, which identifies how to interpret the block. Finally, we have the block’s data, which is type-dependent.</p>
<pre><code>  64        32       16
</code></pre>
<p>| length | checksum | type | … data …</p>
<p>Checksums are computed by taking the CRC32 of the data region, THEN the block header: the length, the checksum (all zeroes, for purposes of computing the checksum itself), and the type. We compute checksums this way so that writers can write large blocks of data with an unknown size in a single pass.</p>
<h2><a href="#index-blocks-type-1" id="index-blocks-type-1"></a>Index Blocks (Type 1)</h2>
<p>An index block lays out the overall arrangement of the file: it stores a map of logical block numbers to file offsets, and also stores a root id, which identifies the block containing the top-level test map. The root id comes first, and is followed by the block map: a series of pairs, each a 32-bit logical block ID and an offset into the file.</p>
<pre><code> 32      32       64       32      64
</code></pre>
<p>root id | id 1 | offset 1 | id 2 | offset 2 | …</p>
<p>There is no block with ID 0: 0 is used as a nil sentinel when one wishes to indicate the absence of a block.</p>
<h2><a href="#fressian-blocks-type-2" id="fressian-blocks-type-2"></a>Fressian Blocks (Type 2)</h2>
<p>A <em>Fressian block</em> encodes data (often a key-value map) using the Fressian serialization format. This is already the workhorse for Jepsen serialization, but we introduce a twist: large values, like the history and results, can be stored in other blocks. That way you don’t have to deserialize the entire thing in order to read the top-level structure.</p>
<p>We create a special datatype, BlockRef, which we encode as a ‘block-ref’ tag in Fressian. This ref simply contains the ID of the block which encodes that tag’s value.</p>
<p>| fressian data … |</p>
<h2><a href="#partialmap-type-3" id="partialmap-type-3"></a>PartialMap (Type 3)</h2>
<p>Results are a bit weird. We want to efficiently fetch the :valid? field from them, but the rest of the result map could be <em>enormous</em>. To speed this up, we want to be able to write <em>part</em> of a map (for instance, just the results :valid? field), and store the rest in a different block.</p>
<p>A PartialMap is essentially a cons cell: it comprises a Fressian-encoded map and a pointer to the ID of a <em>rest</em> block (also a PartialMap) which encodes the remainder of the map. This makes access to those parts of the map encoded in the head cell fast.</p>
<pre><code>   32
</code></pre>
<p>| rest-ptr | fressian data …</p>
<p>When rest-ptr is 0, that indicates there is no more data remaining.</p>
<h2><a href="#fressianstream-type-4" id="fressianstream-type-4"></a>FressianStream (Type 4)</h2>
<p>A FressianStream block allows us to write multiple Fressian-encoded values into a single block. We represent it as:</p>
<p>| fressian data 1 … | fressian data 2 … | …</p>
<p>Writers can write any number of Fressian-encoded values to the stream one after the next. Readers start at the beginning and read values until the block is exhausted. There is no count associated with this block type; it must be inferred by reading all elements. We generally deserialize streams as vectors to enable O(1) access and faster reductions over elements.</p>
<h2><a href="#bigvector-type-5" id="bigvector-type-5"></a>BigVector (Type 5)</h2>
<p>Histories are chonky boys. 100K operations (each a map) are common, and it’s conceivable we might want to work with histories of tens of millions of operations. We also want to write them incrementally, so that we can recover from crashes. It’s also nice to be able to deserialize small bits of the history, or to reduce over it in parallel. To do this, we need a streaming format for large vectors.</p>
<p>We write each chunk of the vector as a separate block. Then we refer to those chunks with a BigVector, which stores some basic metadata about the vector as a whole, and then pointers to each block. Its format is:</p>
<pre><code> 64        64        32          64         32
</code></pre>
<p>| count | index 1 | pointer 1 | index 2 | pointer 2 | …</p>
<p>Count is the number of elements in the vector overall. Index 1 is always 0–the offset of the first element in the first chunk. Pointer 1 is the block ID of the Fressian block which contains the first chunk’s data. Index 2 is the index of the first element in the second chunk, and pointer 2 is the block ID of the second chunk’s data, and so on.</p>
<p>Chunk data can be stored in a Fressian block, a FressianStream block, or another BigVector.</p>
<p>Access to BigVectors looks very much like a regular Clojure vector. We deserialize chunks on-demand, caching results as they’re accessed. We can offer O(1) <code>count</code> through the count field. We implement <code>nth</code> by finding the chunk a given index belongs to and then looking up the index in that chunk. Assoc works by assoc’ing into that particular chunk, leaving other chunks unchanged.</p>
<h2><a href="#thats-it" id="thats-it"></a>That’s It</h2>
<p>There’s a lot of obvious stuff I’ve left out here–metadata, top-level integrity checks, garbage collection, etc etc… but I think we can actually skip almost all of it and get a ton of benefit for the limited use case Jepsen needs.</p>
<ol>
<li>
<p>Write the header.</p>
</li>
<li>
<p>Write an empty vector as block 1, for the history.</p>
</li>
<li>
<p>Write the initial test map as a PartialMap block to block 2, pointing to block 1 as the history. Write an index block pointing to 2 as the root.</p>
</li>
<li>
<p>Write the history incrementally as the test proceeds. Write operations as they occur to a new FressianStream block. Periodically, and at the end of the history:</p>
</li>
</ol>
<p>a. Seal that FressianStream block, writing the headers. Call that block id B. b. Write a new version of the history block with a new chunk appended: B. c. Write a new index block with the new history block version.</p>
<p>This ensures that if we crash during the run, we can recover at least some of the history up to the most recent checkpoint.</p>
<ol>
<li>
<p>Write the results as a PartialMap to blocks 4 and 5: 4 containing the :valid? field, and 5 containing the rest of the results.</p>
</li>
<li>
<p>The test may contain state which changed by the end of the test, and we might want to save that state. Write the entire test map again as block 6, again using block 1 as the history, and now block 5 as the results map. Write a new index block with block 6 as the root.</p>
</li>
</ol>
<p>To read this file, we:</p>
<ol>
<li>
<p>Check the magic and version.</p>
</li>
<li>
<p>Read the index block offset.</p>
</li>
<li>
<p>Read the index block into memory.</p>
</li>
<li>
<p>Look up the root block ID, use the index to work out its offset, read that block, and decode it into a lazy map structure.</p>
</li>
</ol>
<p>When it comes time to reference the results or history in that lazy map, we look up the right block in the block index, seek to that offset, and decode whatever’s there.</p>
<p>Decoding a block is straightforward. We grab the length header, run a CRC over that region of the file, check the block type, then decode the remaining data based on the block structure.</p>
</div></div><div class="public anchor" id="var-append-to-big-vector-block.21"><h3>append-to-big-vector-block!</h3><div class="usage"><code>(append-to-big-vector-block! w element)</code></div><div class="doc"><div class="markdown"><p>Appends an element to a BigVector block writer. This function is asynchronous and returns as soon as the writer’s queue has accepted the element. Close the writer to complete the process. Returns writer.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1165">view source</a></div></div><div class="public anchor" id="var-append-to-fressian-stream-block.21"><h3>append-to-fressian-stream-block!</h3><div class="usage"><code>(append-to-fressian-stream-block! writer data)</code></div><div class="doc"><div class="markdown"><p>Takes a FressianStreamBlockWriter and a Clojure value. Appends that value as Fressian to the stream. Returns writer.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1032">view source</a></div></div><div class="public anchor" id="var-assoc-block.21"><h3>assoc-block!</h3><div class="usage"><code>(assoc-block! handle id offset)</code></div><div class="doc"><div class="markdown"><p>Takes a handle, a block ID, and its corresponding offset. Updates the handle’s block index (in-memory) to add this mapping. Returns handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L808">view source</a></div></div><div class="public anchor" id="var-big-vector-block-writer.21"><h3>big-vector-block-writer!</h3><div class="usage"><code>(big-vector-block-writer! handle elements-per-chunk)</code><code>(big-vector-block-writer! handle block-id elements-per-chunk)</code></div><div class="doc"><div class="markdown"><p>Takes a handle, a optional block ID, and the maximum number of elements per chunk. Returns a BigVectorBlockWriter which can have elements appended to it via append-to-big-vector-block!. Those elements, in turn, are appended to a series of newly created FressianStream blocks, each of which is stitched together into a BigVector block with the given ID. As each chunk of writes is finished, the writer automatically writes a new block index, ensuring we can recover at least part of the history from crashes.</p>
<p>The writer is asynchronous: it internally spawns a thread for serialization and IO. Appends to the writer are transferred to the IO thread via a queue; the IO thread then writes them to disk. Closing the writer blocks until the transfer queue is exhausted.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1137">view source</a></div></div><div class="public anchor" id="var-big-vector-block-writer-worker.21"><h3>big-vector-block-writer-worker!</h3><div class="usage"><code>(big-vector-block-writer-worker! handle block-id elements-per-chunk queue)</code></div><div class="doc"><div class="markdown"><p>Loop which writes values from a BigVectorBlockWriter’s queue to disk.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1084">view source</a></div></div><div class="public anchor" id="var-big-vector-chunk-size"><h3>big-vector-chunk-size</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How many elements should we write to a chunk of a BigVector before starting a new one?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L372">view source</a></div></div><div class="public anchor" id="var-big-vector-count-size"><h3>big-vector-count-size</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How many bytes do we use to store a bigvector’s count?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L353">view source</a></div></div><div class="public anchor" id="var-big-vector-index-size"><h3>big-vector-index-size</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How many bytes do we use to store a bigvector element’s index?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L357">view source</a></div></div><div class="public anchor" id="var-block-checksum"><h3>block-checksum</h3><div class="usage"><code>(block-checksum header data)</code></div><div class="doc"><div class="markdown"><p>Compute the checksum of a block, given two bytebuffers: one for the header, and one for the data.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L628">view source</a></div></div><div class="public anchor" id="var-block-checksum-given-data-checksum"><h3>block-checksum-given-data-checksum</h3><div class="usage"><code>(block-checksum-given-data-checksum header data-crc)</code></div><div class="doc"><div class="markdown"><p>Computes the checksum of a block, given a ByteBuffer header, and an already-computed CRC32 checksum of the data. Useful for streaming writers which compute their own checksums while writing. Mutates data-crc in place; I can’t figure out how to safely copy it.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L616">view source</a></div></div><div class="public anchor" id="var-block-checksum-offset"><h3>block-checksum-offset</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Where do we write a checksum in the block header?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L325">view source</a></div></div><div class="public anchor" id="var-block-checksum-size"><h3>block-checksum-size</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How long is the checksum for a block?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L321">view source</a></div></div><div class="public anchor" id="var-block-header"><h3>block-header</h3><div class="usage"><code>(block-header)</code></div><div class="doc"><div class="markdown"><p>Returns a blank ByteBuffer for a block header. All fields zero.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L578">view source</a></div></div><div class="public anchor" id="var-block-header-checksum"><h3>block-header-checksum</h3><div class="usage"><code>(block-header-checksum header)</code></div><div class="doc"><div class="markdown"><p>Fetches the checksum of a block header.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L606">view source</a></div></div><div class="public anchor" id="var-block-header-for-data"><h3>block-header-for-data</h3><div class="usage"><code>(block-header-for-data block-type data)</code></div><div class="doc"><div class="markdown"><p>Takes a block type and a ByteBuffer of data, and constructs a block header whose type is the given type, and which has the appropriate length and checksum for the given data.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L724">view source</a></div></div><div class="public anchor" id="var-block-header-for-length-and-checksum.21"><h3>block-header-for-length-and-checksum!</h3><div class="usage"><code>(block-header-for-length-and-checksum! block-type data-length data-checksum)</code></div><div class="doc"><div class="markdown"><p>An optimized way to construct a block header, a block type, the length of a data region (not including headers) and the CRC checksum of that data. Mutates the checksum in place.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L712">view source</a></div></div><div class="public anchor" id="var-block-header-length"><h3>block-header-length</h3><div class="usage"><code>(block-header-length header)</code></div><div class="doc"><div class="markdown"><p>Fetches the length of a block header.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L596">view source</a></div></div><div class="public anchor" id="var-block-header-size"><h3>block-header-size</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How long is a block header?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L349">view source</a></div></div><div class="public anchor" id="var-block-header-type"><h3>block-header-type</h3><div class="usage"><code>(block-header-type header)</code></div><div class="doc"><div class="markdown"><p>Returns the type of a block header, as a keyword.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L583">view source</a></div></div><div class="public anchor" id="var-block-id-size"><h3>block-id-size</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How many bytes per block ID?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L295">view source</a></div></div><div class="public anchor" id="var-block-index-data-size"><h3>block-index-data-size</h3><div class="usage"><code>(block-index-data-size index)</code></div><div class="doc"><div class="markdown"><p>Takes a block index and returns the number of bytes required for that block to be written, NOT including headers.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L822">view source</a></div></div><div class="public anchor" id="var-block-index-offset-offset"><h3>block-index-offset-offset</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Where in the file do we write the offset of the index block?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L303">view source</a></div></div><div class="public anchor" id="var-block-len-offset"><h3>block-len-offset</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Where do we write a block length in a block header?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L317">view source</a></div></div><div class="public anchor" id="var-block-len-size"><h3>block-len-size</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How long is the length prefix for a block?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L313">view source</a></div></div><div class="public anchor" id="var-block-offset-size"><h3>block-offset-size</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How many bytes per block offset address?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L299">view source</a></div></div><div class="public anchor" id="var-block-ref"><h3>block-ref</h3><div class="usage"><code>(block-ref id)</code></div><div class="doc"><div class="markdown"><p>Constructs a new BlockRef object pointing to the given block ID.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L379">view source</a></div></div><div class="public anchor" id="var-block-references"><h3>block-references</h3><div class="usage"><code>(block-references handle)</code><code>(block-references handle block-id)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and a block ID, and returns the set of all block IDs which that block references. Right now we do this by parsing the block data; later we might want to move references into block headers. With no block ID, returns references from the root.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1481">view source</a></div></div><div class="public anchor" id="var-block-type-.3Eshort"><h3>block-type-&gt;short</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>A map of block types to integer codes.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L345">view source</a></div></div><div class="public anchor" id="var-block-type-offset"><h3>block-type-offset</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Where do we store the block type in a block header?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L333">view source</a></div></div><div class="public anchor" id="var-block-type-size"><h3>block-type-size</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How long is the type for a block?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L329">view source</a></div></div><div class="public anchor" id="var-check-block-checksum"><h3>check-block-checksum</h3><div class="usage"><code>(check-block-checksum header data)</code></div><div class="doc"><div class="markdown"><p>Verifies the checksum of a block, given two ByteBuffers: one for the header, and one for the data.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L638">view source</a></div></div><div class="public anchor" id="var-check-magic"><h3>check-magic</h3><div class="usage"><code>(check-magic handle)</code></div><div class="doc"><div class="markdown"><p>Takes a Handle and reads the magic bytes, ensuring they match.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L487">view source</a></div></div><div class="public anchor" id="var-check-version.21"><h3>check-version!</h3><div class="usage"><code>(check-version! handle)</code></div><div class="doc"><div class="markdown"><p>Takes a Handle and reads the version. Ensures it’s a version we can decode, and updates the Handle’s version if it hasn’t already been set.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L504">view source</a></div></div><div class="public anchor" id="var-close.21"><h3>close!</h3><div class="usage"><code>(close! handle)</code></div><div class="doc"><div class="markdown"><p>Closes a Handle</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L416">view source</a></div></div><div class="public anchor" id="var-copy.21"><h3>copy!</h3><div class="usage"><code>(copy! r w)</code></div><div class="doc"><div class="markdown"><p>Takes two handles: a reader and a writer. Copies the root and any other referenced blocks from reader to writer.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1508">view source</a></div></div><div class="public anchor" id="var-current-version"><h3>current-version</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>The current file version.</p>
<p>Version 0 was the first version of the file format.</p>
<p>Version 1 added support for FressianStream and BigVector blocks.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L279">view source</a></div></div><div class="public anchor" id="var-find-references"><h3>find-references</h3><div class="usage"><code>(find-references x)</code></div><div class="doc"><div class="markdown"><p>A little helper function for finding BlockRefs in a nested data structure. Returns the IDs of all BlockRefs.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1469">view source</a></div></div><div class="public anchor" id="var-first-block-offset"><h3>first-block-offset</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Where in the file the first block begins.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L307">view source</a></div></div><div class="public anchor" id="var-flush.21"><h3>flush!</h3><div class="usage"><code>(flush! handle)</code></div><div class="doc"><div class="markdown"><p>Flushes writes to a Handle to disk.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L422">view source</a></div></div><div class="public anchor" id="var-fressian-buffer-size"><h3>fressian-buffer-size</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How many bytes should we buffer before writing Fressian data to disk?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L368">view source</a></div></div><div class="public anchor" id="var-fressian-read-handlers"><h3>fressian-read-handlers</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How do we read Fressian data?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L923">view source</a></div></div><div class="public anchor" id="var-fressian-stream-block-writer.21"><h3>fressian-stream-block-writer!</h3><div class="usage"><code>(fressian-stream-block-writer! handle)</code></div><div class="doc"><div class="markdown"><p>Takes a handle. Creates a new block ID, and prepares to write a new FressianStream block at the end of the file. Returns a FressianStreamBlockWriter which can be used to write elements to the FressianStream. When closed, the writer writes the block header and updates the handle’s block index to refer to the new block.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1015">view source</a></div></div><div class="public anchor" id="var-fressian-write-handlers"><h3>fressian-write-handlers</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How do we write Fressian data?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L912">view source</a></div></div><div class="public anchor" id="var-gc.21"><h3>gc!</h3><div class="usage"><code>(gc! file)</code></div><div class="doc"><div class="markdown"><p>Garbage-collects a file (anything that works with io/file) in-place.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1588">view source</a></div></div><div class="public anchor" id="var-IPartialMap"><h3>IPartialMap</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var-partial-map-rest-id"><h3>partial-map-rest-id</h3><div class="usage"><code>(partial-map-rest-id this)</code></div><div class="doc"><div class="markdown"></div></div></div></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1252">view source</a></div></div><div class="public anchor" id="var-large-region-size"><h3>large-region-size</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>How big does a file region have to be before we just mmap it instead of doing file reads?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L363">view source</a></div></div><div class="public anchor" id="var-load-block-index.21"><h3>load-block-index!</h3><div class="usage"><code>(load-block-index! handle)</code></div><div class="doc"><div class="markdown"><p>Takes a handle, reloads its block index from disk, and returns handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L875">view source</a></div></div><div class="public anchor" id="var-magic"><h3>magic</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>The magic string at the start of Jepsen files.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L267">view source</a></div></div><div class="public anchor" id="var-magic-offset"><h3>magic-offset</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Where the magic is written</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L275">view source</a></div></div><div class="public anchor" id="var-magic-size"><h3>magic-size</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Bytes it takes to store the magic string.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L271">view source</a></div></div><div class="public anchor" id="var-new-block-id.21"><h3>new-block-id!</h3><div class="usage"><code>(new-block-id! handle)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and returns a fresh block ID for that handle, mutating the handle so that this ID will not be allocated again.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L789">view source</a></div></div><div class="public anchor" id="var-next-block-offset"><h3>next-block-offset</h3><div class="usage"><code>(next-block-offset handle)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and returns the offset of the next block. Right now this is just the end of the file.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L801">view source</a></div></div><div class="public anchor" id="var-open"><h3>open</h3><div class="usage"><code>(open path)</code></div><div class="doc"><div class="markdown"><p>Constructs a new handle for a Jepsen file of the given path (anything which works with io/file).</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L402">view source</a></div></div><div class="public anchor" id="var-prep-read.21"><h3>prep-read!</h3><div class="usage"><code>(prep-read! handle)</code></div><div class="doc"><div class="markdown"><p>Called when we read anything from a handle. Ensures that we’ve checked the magic, version, and loaded the block index.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L541">view source</a></div></div><div class="public anchor" id="var-prep-write.21"><h3>prep-write!</h3><div class="usage"><code>(prep-write! handle)</code></div><div class="doc"><div class="markdown"><p>Called when we write anything to a handle. Ensures that we’ve written the header before doing anything else. Returns handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L531">view source</a></div></div><div class="public anchor" id="var-read-big-vector-block"><h3>read-big-vector-block</h3><div class="usage"><code>(read-big-vector-block handle buf)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and a ByteBuffer for a big-vector block. Returns a lazy vector (specifically, a soft chunked vector) representing its data.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1173">view source</a></div></div><div class="public anchor" id="var-read-block-by-id"><h3>read-block-by-id</h3><div class="usage"><code>(read-block-by-id handle id)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and a logical block id. Looks up the offset for the given block and reads it using read-block-by-offset (which includes verifying the checksum).</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L888">view source</a></div></div><div class="public anchor" id="var-read-block-by-offset"><h3>read-block-by-offset</h3><div class="usage"><code>(read-block-by-offset handle offset)</code></div><div class="doc"><div class="markdown"><p>Takes a Handle and the offset of a block. Reads the block header, validates the checksum, and interprets the block data depending on the block type. Returns a map of:</p>
<p>{:type   The block type, as a keyword :offset The offset of this block :length How many bytes are in this block, total :data   The interpreted data stored in this block—depends on block type}</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L764">view source</a></div></div><div class="public anchor" id="var-read-block-by-offset*"><h3>read-block-by-offset*</h3><div class="usage"><code>(read-block-by-offset* handle offset)</code></div><div class="doc"><div class="markdown"><p>Takes a Handle and the offset of a block. Reads the block header and data, validates the checksum, and returns a map of:</p>
<p>{:header header, as bytebuffer :data   data, as bytebuffer}</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L743">view source</a></div></div><div class="public anchor" id="var-read-block-data"><h3>read-block-data</h3><div class="usage"><code>(read-block-data handle offset header)</code></div><div class="doc"><div class="markdown"><p>Fetches the ByteBuffer for a block’s data, given a block header stored at the given offset.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L666">view source</a></div></div><div class="public anchor" id="var-read-block-header"><h3>read-block-header</h3><div class="usage"><code>(read-block-header handle offset)</code></div><div class="doc"><div class="markdown"><p>Fetches the ByteBuffer for a block header at the given offset.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L649">view source</a></div></div><div class="public anchor" id="var-read-block-index-block"><h3>read-block-index-block</h3><div class="usage"><code>(read-block-index-block handle data)</code></div><div class="doc"><div class="markdown"><p>Takes a ByteBuffer and reads a block index from it: a map of</p>
<p>{:root   root-id :blocks {id offset, id2 offset2, …}}</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L860">view source</a></div></div><div class="public anchor" id="var-read-block-index-offset"><h3>read-block-index-offset</h3><div class="usage"><code>(read-block-index-offset handle)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and returns the current root block index offset from its file. Throws :type ::no-block-index if the block index is 0 or the file is too short.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L560">view source</a></div></div><div class="public anchor" id="var-read-file"><h3>read-file</h3><div class="usage"><code>(read-file file offset size)</code></div><div class="doc"><div class="markdown"><p>Returns a ByteBuffer corresponding to a given file region. Uses mmap for large regions, or regular read calls for small ones.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L446">view source</a></div></div><div class="public anchor" id="var-read-fressian-block"><h3>read-fressian-block</h3><div class="usage"><code>(read-fressian-block handle data)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and a ByteBuffer of data from a Fressian block. Returns its parsed contents.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L982">view source</a></div></div><div class="public anchor" id="var-read-fressian-stream-block"><h3>read-fressian-stream-block</h3><div class="usage"><code>(read-fressian-stream-block handle data)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and a ByteBuffer of data from a FressianStream block. Returns its contents as a vector.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1039">view source</a></div></div><div class="public anchor" id="var-read-partial-map-block"><h3>read-partial-map-block</h3><div class="usage"><code>(read-partial-map-block handle data)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and a ByteBuffer for a partial-map block. Returns a lazy map representing its data.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1287">view source</a></div></div><div class="public anchor" id="var-read-root"><h3>read-root</h3><div class="usage"><code>(read-root handle)</code></div><div class="doc"><div class="markdown"><p>Takes a handle. Looks up the root block from the current block index and reads it. Returns nil if there is no root.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L902">view source</a></div></div><div class="public anchor" id="var-read-test"><h3>read-test</h3><div class="usage"><code>(read-test handle)</code></div><div class="doc"><div class="markdown"><p>Reads a test from a handle’s root. Constructs a lazy test map where history and results are loaded as-needed from the file. Leave the handle open so this map can use it; it’ll be automatically closed when this map is GCed. Includes metadata so that this test can be rewritten using write-results!</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1436">view source</a></div></div><div class="public anchor" id="var-set-block-header-checksum.21"><h3>set-block-header-checksum!</h3><div class="usage"><code>(set-block-header-checksum! buf checksum)</code></div><div class="doc"><div class="markdown"><p>Sets the checksum in a block header. Returns the block header.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L611">view source</a></div></div><div class="public anchor" id="var-set-block-header-length.21"><h3>set-block-header-length!</h3><div class="usage"><code>(set-block-header-length! buf length)</code></div><div class="doc"><div class="markdown"><p>Sets the length in a block header. Returns the block header.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L601">view source</a></div></div><div class="public anchor" id="var-set-block-header-type.21"><h3>set-block-header-type!</h3><div class="usage"><code>(set-block-header-type! buf block-type)</code></div><div class="doc"><div class="markdown"><p>Sets the type (a keyword) in a block header. Returns the header.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L588">view source</a></div></div><div class="public anchor" id="var-set-root.21"><h3>set-root!</h3><div class="usage"><code>(set-root! handle root-id)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and a block ID. Updates the handle’s block index (in-memory) to point to this block ID as the root. Returns handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L815">view source</a></div></div><div class="public anchor" id="var-short-.3Eblock-type"><h3>short-&gt;block-type</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>A map of integers to block types.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L337">view source</a></div></div><div class="public anchor" id="var-test-history-writer.21"><h3>test-history-writer!</h3><div class="usage"><code>(test-history-writer! handle test)</code><code>(test-history-writer! handle test chunk-size)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and a test created with write-initial-test!, and returns a BigVectorBlockWriter for writing operations to the history. Append elements using <code>append-to-big-vector-block!</code>, and .close the writer when done.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1325">view source</a></div></div><div class="public anchor" id="var-version"><h3>version</h3><div class="usage"><code>(version handle)</code></div><div class="doc"><div class="markdown"><p>Returns the version of a Handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L397">view source</a></div></div><div class="public anchor" id="var-version-offset"><h3>version-offset</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Where in the file the version begins</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L291">view source</a></div></div><div class="public anchor" id="var-version-size"><h3>version-size</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Bytes it takes to store a version.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L287">view source</a></div></div><div class="public anchor" id="var-write-big-vector-block.21"><h3>write-big-vector-block!</h3><div class="usage"><code>(write-big-vector-block! handle id element-count chunks)</code></div><div class="doc"><div class="markdown"><p>Takes a handle, a block ID, a count, and a vector of <a href="initial-index
block-id">initial-index block-id</a> chunks. Writes a BigVector block with the given count and chunks to the end of the file. Records the freshly written block in the handle’s block index, and returns ID.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1055">view source</a></div></div><div class="public anchor" id="var-write-block.21"><h3>write-block!</h3><div class="usage"><code>(write-block! handle offset block-type data)</code></div><div class="doc"><div class="markdown"><p>Writes a block to a handle at the given offset, given a block type as a keyword and a ByteBuffer for the block’s data. Returns handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L735">view source</a></div></div><div class="public anchor" id="var-write-block-data.21"><h3>write-block-data!</h3><div class="usage"><code>(write-block-data! handle offset data)</code></div><div class="doc"><div class="markdown"><p>Writes block data to the given block offset (e.g. the address of the header, not the data itself) in the file, backed by the given handle. Returns handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L703">view source</a></div></div><div class="public anchor" id="var-write-block-header.21"><h3>write-block-header!</h3><div class="usage"><code>(write-block-header! handle offset block-header)</code></div><div class="doc"><div class="markdown"><p>Writes a block header to the given offset in the file backed by the given handle. Returns handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L687">view source</a></div></div><div class="public anchor" id="var-write-block-index.21"><h3>write-block-index!</h3><div class="usage"><code>(write-block-index! handle)</code><code>(write-block-index! handle offset)</code></div><div class="doc"><div class="markdown"><p>Writes a block index for a Handle, based on whatever that Handle’s current block index is. Automatically generates a new block ID for this index and adds it to the handle as well. Then writes a new block index offset pointing to this block index. Returns handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L830">view source</a></div></div><div class="public anchor" id="var-write-block-index-offset.21"><h3>write-block-index-offset!</h3><div class="usage"><code>(write-block-index-offset! handle root)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and the offset of a block index block to use as the new root. Updates the file’s block pointer. Returns handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L551">view source</a></div></div><div class="public anchor" id="var-write-file.21"><h3>write-file!</h3><div class="usage"><code>(write-file! file offset buffer)</code></div><div class="doc"><div class="markdown"><p>Takes a FileChannel, an offset, and a ByteBuffer. Writes the ByteBuffer to the FileChannel at the given offset completely. Returns number of bytes written.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L430">view source</a></div></div><div class="public anchor" id="var-write-fressian-block.21"><h3>write-fressian-block!</h3><div class="usage"><code>(write-fressian-block! handle data)</code><code>(write-fressian-block! handle id data)</code></div><div class="doc"><div class="markdown"><p>Takes a handle, an optional block ID, and some Clojure data. Writes that data to a Fressian block at the end of the file, records the new block in the handle’s block index, and returns the ID of the newly written block.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L969">view source</a></div></div><div class="public anchor" id="var-write-fressian-block.21*"><h3>write-fressian-block!*</h3><div class="usage"><code>(write-fressian-block!* handle offset data)</code></div><div class="doc"><div class="markdown"><p>Takes a handle, a byte offset, and some Clojure data. Writes that data to a Fressian block at the given offset. Returns handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L949">view source</a></div></div><div class="public anchor" id="var-write-fressian-to-file.21"><h3>write-fressian-to-file!</h3><div class="usage"><code>(write-fressian-to-file! file offset checksum data)</code></div><div class="doc"><div class="markdown"><p>Takes a FileChannel, an offset, a checksum, and a data structure as Fressian. Writes the data structure as Fressian to the file at the given offset. Returns the size of the data that was just written, in bytes. Mutates checksum with written bytes.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L931">view source</a></div></div><div class="public anchor" id="var-write-header.21"><h3>write-header!</h3><div class="usage"><code>(write-header! handle)</code></div><div class="doc"><div class="markdown"><p>Takes a Handle and writes the initial magic bytes and version number. Initializes the handle’s version to current-version if it hasn’t already been set. Returns handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L465">view source</a></div></div><div class="public anchor" id="var-write-initial-test.21"><h3>write-initial-test!</h3><div class="usage"><code>(write-initial-test! handle test)</code></div><div class="doc"><div class="markdown"><p>Writes an initial test to a handle, making the test the root. Creates an (initially nil) block for the history. Called when we first begin a test. Returns test with additional metadata, so we can write the history and results later.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1313">view source</a></div></div><div class="public anchor" id="var-write-partial-map-block.21"><h3>write-partial-map-block!</h3><div class="usage"><code>(write-partial-map-block! handle m rest-id)</code><code>(write-partial-map-block! handle id m rest-id)</code></div><div class="doc"><div class="markdown"><p>Takes a handle, a Clojure map, and the ID of the block which stores the rest of the map (use <code>nil</code> if there is no more data to the PartialMap). Writes the map to a new PartialMap block, records it in the handle’s block index, and returns the ID of this block itself. Optionally takes an explicit ID for this block.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1234">view source</a></div></div><div class="public anchor" id="var-write-partial-map-block.21*"><h3>write-partial-map-block!*</h3><div class="usage"><code>(write-partial-map-block!* handle offset m rest-id)</code></div><div class="doc"><div class="markdown"><p>Takes a handle, a byte offset, a Clojure map, and the ID of the block which stores the rest of the map (use <code>nil</code> if there is no more to the PartialMap). Writes the map and rest pointer to a PartialMap block at the given offset. Returns handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1203">view source</a></div></div><div class="public anchor" id="var-write-test.21"><h3>write-test!</h3><div class="usage"><code>(write-test! handle test)</code></div><div class="doc"><div class="markdown"><p>Writes an entire test map to a handle, making the test the root. Useful for re-writing a completed test that’s already in memory, and migrating existing Fressian tests to the new format. Returns handle.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1376">view source</a></div></div><div class="public anchor" id="var-write-test-with-history.21"><h3>write-test-with-history!</h3><div class="usage"><code>(write-test-with-history! handle test)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and a test created with write-initial-test!, and writes it again as the root. Used for rewriting a test after running it, but before analysis, in case there’s state that changed. Returns test.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1339">view source</a></div></div><div class="public anchor" id="var-write-test-with-results.21"><h3>write-test-with-results!</h3><div class="usage"><code>(write-test-with-results! handle test)</code></div><div class="doc"><div class="markdown"><p>Takes a handle and a test created with write-initial-test!, and appends its :results as a partial map block: :valid? in the top tier, and other results below. Writes test using those results and history blocks. Returns test, with ::results-id metadata pointing to the block ID of these results.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.8/jepsen/src/jepsen/store/format.clj#L1353">view source</a></div></div></div></body></html>